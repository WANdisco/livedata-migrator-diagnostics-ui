<!DOCTYPE html>
<html lang="en">
<head>
<title>LiveData Migrator Diagnostics</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/nouislider.min.css">
<link rel="stylesheet" href="css/diagnostics.css">
<script src="js/chart.min.js"></script>
<script src="js/chartjs-plugin-annotation.min.js"></script>
<script src="js/common.js"></script>
<script src="js/nouislider.min.js"></script>

</head>

<body>
<!-- Navbar -->
<div class="topnav">
    <a id="index-link", href="index.html"  style="background-color: #FED8B1;">Summary</a>
    <a id="throughput-link", href="throughput.html">Throughput</a>
    <a id="system-link" href="system.html">System</a>
    <a id="network-link" href="network.html">Network</a>
    <a id="migrations-link" href="migrations.html">Migrations</a>
    <a id="filetrackers-link" href="filetrackers.html">Transfers</a>
</div>



<!-- !PAGE CONTENT! -->
<div  style="margin-left:30px;margin-top:10px;margin-bottom:10px;margin-right:30px">
   <div>
         <canvas id="ThroughPutChart" height="400"></canvas>
   </div>
   <div  style="margin-left:180px;margin-top:50px;margin-bottom:50px;margin-right:180px" id="slider"></div>

   <div style="margin-left:100px;margin-top:50px;margin-right:100px">
      <table id="diagnostic-summary-table-0">   
         <tr>
            <th><span id="table-title-header">-</span></th>
         <tr>
      </table>
      <table id="diagnostic-summary-table-1">   
         <tr id="network-throughput-row" onclick="clickJump(this)" style="cursor: pointer;">
             <th width="250px" >Network Throughput</th>
             <td title="Average for period / Peak for period">Bandwidth</td>
             <td><span id="diagnostic-summary-table-rate-per-second">-</span></td>
             <td title="Average for period / Peak for period">Bytes Per Second</td>
             <td><span id="diagnostic-summary-table-bytes-per-second">-</span></td>
      <table id="diagnostic-summary-table-12" style="margin-top:10px">   
         <tr id="file-throughput-row" onclick="clickJump(this)" style="cursor: pointer;">
             <th width="250px" >File Throughput</th>
             <td title="Average for period / Peak for period">Files Per Second</td>
             <td><span id="diagnostic-summary-table-file-per-second">-</span></td>
             <td>Files For Period (<span id="diagnostic-summary-table-file-period">-</span>s)</td>
             <td><span id="diagnostic-summary-table-file-for-period">-</span></td>
         </tr>
      </table>
      <table id="diagnostic-summary-table-7" style="margin-top:10px">   
         <tr id="file-tracker-row" onclick="clickJump(this)" style="cursor: pointer;">
            <th width="250px" title="The file transfers that were occuring when the diagnostics were recorded at this time. Clicking on this row will take you to the list of active file transfers.">Active File Transfers</th>
            <td title="Count of the file transfers occuring when the diagnostic was recorded.">File Transfers</td>
            <td><span id="diagnostic-summary-active-transfers">-</span></td>
            <td title="The amount of data already transferred for files in transit. / The total size of the files in transit. ">Total Size Transferring</td>
            <td><span id="diagnostic-summary-total-size-transfers">-</span></td>
         </tr>
      </table>
      <table id="diagnostic-summary-table-5" style="margin-top:10px">   
         <tr id="migration-row" onclick="clickJump(this)" style="cursor: pointer;">
             <th width="250px" title="The three main queues of work for the migrations.">Migration Queues</th>
             <td>Events</td>
             <td><span id="diagnostic-summary-event-queue">-</span></td>
             <td>Pending Regions</td>
             <td><span id="diagnostic-summary-pending-region">-</span></td>
             <td>Actions</td>
             <td><span id="diagnostic-summary-action-queue">-</span></td>
         </tr>
      </table>
      <table id="diagnostic-summary-table-6" style="margin-top:10px">   
         <tr id="migration-failure-row" onclick="clickJump(this)" style="cursor: pointer;">
             <th width="250px" >Migration Failure/Retry</th>
             <td>Total Failed Paths</td>
             <td><span id="diagnostic-summary-failed-paths">-</span></td>
             <td>Total Retries</td>
             <td><span id="diagnostic-summary-total-retries">-</span></td>
             <td>Total Requeus</td>
             <td><span id="diagnostic-summary-total-requeues">-</span></td>
         </tr>
      </table>
      <table id="diagnostic-summary-table-4" style="margin-top:10px">   
         <tr id="filesystem-event-row" onclick="clickJump(this)" style="cursor: pointer;">
            <th width="250px" >FileSystem Events</th>
            <td>Events Added</td>
            <td><span id="diagnostic-summary-event-manager-added">-</span></td>
            <td title="Sample of the average time spent on a database write in ms. If this figure is high then sysetm may be IO bound.">Avg Database Time</td>
            <td><span id="diagnostic-summary-event-manager-avg-db">-</span></td>
            <td title="Maxium database write time in ms. If this is high then system could be under IO pressure.">Max Database Time</td>
            <td><span id="diagnostic-summary-event-manager-max-db">-</span></td>
         </tr>
      </table>
      <table id="diagnostic-summary-table-2" style="margin-top:10px">   
         <tr id="network-status-row" onclick="clickJump(this)" style="cursor: pointer;">
             <th width="250px" >Network Status</th>
             <td>Connections</td>
             <td><span id="diagnostic-summary-table-connections">-</span></td>
             <td title="Total data buffered by OS for reading from connections. This is data to be consumed from the source">Rx Buffers</td>
             <td><span id="diagnostic-summary-table-rx">-</span></td>
             <td title="Total data buffered by the OS for sending to the target.">Tx Buffers</td>
             <td><span id="diagnostic-summary-table-tx">-</span></td>
             <td title="Total TCP retransmits across the connections. Retransmits impacts network performance, this should be zero.">Retransmits</td>
             <td><span id="diagnostic-summary-table-retransmit">-</span></td>
         </tr>
      </table>
      <table id="diagnostic-summary-table-3" style="margin-top:10px; margin-bottom:10px">   
         <tr id="system-row" onclick="clickJump(this)" style="cursor: pointer;">
             <th width="250px" >System</td>
             <td title="Amount of time the CPU is busy across all processes on the syste. 1.0 means 100% of the time.">System CPU</td>
             <td><span id="diagnostic-summary-system-cpu">-</span></td>
             <td title="Amount of CPU time devoted to application. 1.0 means 100% of the time. If this matches System CPU time then application is the main user of CPU resources.">Process CPU</td>
             <td><span id="diagnostic-summary-process-cpu">-</span></td>
             <td title="Percentage of time the OS stalls the system to service disk writes.">IO Wait</td>
             <td><span id="diagnostic-summary-io-wait">-</span></td>
             <td title="Total JVM GC time for the period of the Diagnostic, 60 seconds.">JVM GC Time (ms)</td>
             <td><span id="diagnostic-summary-gc-time-period">-</span></td>
             <td title="Average JVM GC time.">JVM GC Avg (ms)</td>
             <td><span id="diagnostic-summary-gc-avg-time">-</span></td>
         </tr>
      </table>
   </div>

   <div class="charts-wrapper">
      <div>
        <canvas id="ActiveRatePercentiles"></canvas>
        <form action=""><input type="button" style="display: block; margin: auto;" id="ActiveRatePercentilesButton", onclick="changeScaleButton(this);", value="log"></button></form>
      </div>
      <div>
        <canvas id="ActiveFileSizePercentiles"></canvas>
        <form action=""><input type="button" style="display: block; margin: auto;" id="ActiveFileSizePercentilesButton", onclick="changeScaleButton(this);", value="log"></button></form>
      </div>
      <div>
        <canvas id="ActiveLatencyPercentiles"></canvas>
      </div>
      <div>
        <canvas id="ActiveMigrations"></canvas>
      </div>
      <div>
        <canvas id="FileRatePercentiles"></canvas>
        <form action=""><input type="button" style="display: block; margin: auto;" id="FileRatePercentilesButton", onclick="changeScaleButton(this);", value="log"></button></form>
      </div>
      <div>
        <canvas id="FileSizePercentiles"></canvas>
        <form action=""><input type="button" style="display: block; margin: auto;" id="FileSizePercentilesButton", onclick="changeScaleButton(this);", value="log"></button></form>
      </div>
      <div>
        <canvas id="RecentMigrations" ></canvas>
         <form action=""><input type="button" style="display: block; margin: auto;" id="RecentMigrationsButton", onclick="changeScaleButton(this);", value="log"></button></form>
      </div>
   </div>

<!-- !PAGE CONTENT! -->
</div>


<script>
// Datasets
var activeFileTrackerPercentiles;
var fileTrackerPercentiles;
var fileTrackerRatePercentiles;
var recentMigrations;
var byterate;
var filerate;
var jvmGCTimeMap = {};

// Sliders
var slider = document.getElementById('slider');

// Charts
var throughPutChart;
var activeFileRateBarChart;
var activeFileSizeBarChart;
var activeFileLatencyBarChart;
var activeMigrationsChart;
var fileSizeBarChart;
var fileRateBarChart;
var recentMigrationsChart;


function doThroughPutChart(throughput, startIndex, middleIndex, endIndex) {
  byterate = throughput.bytesPerSecond.map(toMBSecond);
  filerate = throughput.filesPerSecond;

  throughPutChart = new Chart("ThroughPutChart", {
    type: "line",
    data: {
      labels: diagnosticsTimeSeries.dates.slice(startIndex, endIndex),
      datasets: [{
        label: "Mbit/s",
        fill: false,
        lineTension: 0.4,
        backgroundColor: transparentize(255, 165, 0, 0.5),
        borderColor: 'rgb(255,165,0)',
        data: byterate.slice(startIndex, endIndex),
        yAxisID: 'y'
      },
      {
        label: "Files Per Second",
        fill: false,
        lineTension: 0.4,
        backgroundColor:  transparentize(54, 162, 235, 0.5),
        borderColor: 'rgb(54, 162, 235)',
        data: filerate.slice(startIndex, endIndex),
        yAxisID: 'y1',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      onHover: (event, chartElement) => {
         event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
      },
      plugins: {
       annotation: {
          annotations: {
            line1: {
              type: 'line',
              xMin: diagnosticsTimeSeries.middle,
              xMax: diagnosticsTimeSeries.middle,
              backgroundColor:  transparentize(255, 68, 51, 0.5),
              borderColor: 'rgb(255, 68, 51)',
              borderWidth: 2,
           }
        }
      },
      title: {
          display: false,
          fullSize: true, 
          font: {
               size: 24
          },
          text: "Throughput",
          color: 'rgb(139, 64, 0)',
        }
      },
      scales: {
        x: {
          display: true,
          title: {
            display: false,
            text: 'Date'
          },
          ticks: {
             autoSkip: true,
             maxTicksLimit: 20,
             callback: function(value, index, ticks) {
                        return this.getLabelForValue(value).slice(0,-3);
                    }
          }
        },
        y: {
          display: true,
          type: 'linear',
          position: 'left', 
          min: 0.0,
          title: {
            display: true,
            text: 'Mbit/s'
          }
        },
        y1: {
          display: true,
          type: 'linear',
          position: 'right', 
          min: 0.0,
          grid: {
             drawOnChartArea: false, // only want the grid lines for one axis to show up
          },
          title: {
            display: true,
            text: 'Files per Second'
          }
        }
      }
    }
  });
}


function updateThroughPutChart() {
  if (typeof throughPutChart === 'undefined') {
     return;
  }

  let startIndex =  diagnosticsTimeSeries.dates.indexOf(diagnosticsTimeSeries.start);
  let endIndex = diagnosticsTimeSeries.dates.indexOf(diagnosticsTimeSeries.end);
  throughPutChart.data.labels = 
            diagnosticsTimeSeries.dates.slice(startIndex, endIndex);
  throughPutChart.data.datasets[0].data = byterate.slice(startIndex, endIndex);
  throughPutChart.data.datasets[1].data = filerate.slice(startIndex, endIndex);
  throughPutChart.options.plugins.annotation.annotations.line1.xMin = 
           diagnosticsTimeSeries.middle;
  throughPutChart.options.plugins.annotation.annotations.line1.xMax = 
           diagnosticsTimeSeries.middle;
  throughPutChart.update();
}


function changeScaleButton(button) {
  if (button.value === "log") {
    button.value = "linear";
  } else {
    button.value = "log";
  }
  // Need to redraw chart.
  if (button.id === "ActiveRatePercentilesButton") {
    processActiveFileRatePercentiles(activeFileTrackerPercentiles);
    return;
  }
  if (button.id === "ActiveFileSizePercentilesButton") {
    processActiveFileSizePercentiles(activeFileTrackerPercentiles);
    return;
  }
  if (button.id === "FileSizePercentilesButton") {
    processFileSizePercentiles(fileTrackerPercentiles);
    return;
  }
  if (button.id === "FileRatePercentilesButton") {
    processFileRatePercentiles(fileTrackerRatePercentiles);
    return;
  }
  if (button.id === "RecentMigrationsButton") {
    processRecentActivityMigrations(recentMigrations);
    return;
  }
}

function getRecentMigrations(diagnosticSet) {
  let diagnostic;
  for (let i in diagnosticSet.diagnostics) {
    diagnostic = diagnosticSet.diagnostics[i];
    if (diagnostic.type === 'FileTrackerDiagnosticDTO') {
      break;
    }
  }
  let recentActivityByMigration = diagnostic.recentActivityByMigration;
  let translatedMap = new Map();
  for (const key in recentActivityByMigration) {
    if (migrationIdMap[key]) {
       translatedMap.set(migrationIdMap[key], recentActivityByMigration[key]);
    } else {
       translatedMap.set(key, recentActivityByMigration[key]);
    }  
  };    

  let recentActivityMigrationName  = [];
  let recentActivityMigrationValue = [];
  let translatedMapSorted = new Map([...translatedMap.entries()].sort((a,b) => b[1] - a[1]));
  translatedMapSorted.forEach(function(value, key) {
     recentActivityMigrationName.push(key);
     recentActivityMigrationValue.push(value);
  })    
  return {recentActivityMigrationName, recentActivityMigrationValue};
}


function processRecentActivityMigrations(recentMigrations) {
  let scaleButton = document.getElementById("RecentMigrationsButton").value;  
  let scaleType = 'linear'
  if (scaleButton === "linear") {
     scaleType = 'logarithmic';
  }

  const data = {
    labels: recentMigrations.recentActivityMigrationName,
    datasets: [
    {
      label: 'Number of files recently transferred for this Migration.',
      data: recentMigrations.recentActivityMigrationValue,
      backgroundColor: transparentize(255, 165, 0, 0.9),
      borderColor: 'rgb(255,165,0)',
    }]
  };

  
  const config = {
  type: 'bar',
  data: data,
  options: {
    indexAxis: 'y',
    responsive: true,
    onHover: (event, chartElement) => {
         event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
    },
    scales : {
      x : {
        display: true,
        type: scaleType,
      },
      y : {
         display: false,
      }
    },
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Migrations with recent file transfers at ' + diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
      tooltip: {
        callbacks: {
           title: function(context) {
              return context[0].label
            }
        },
      },
     },
   },
 };
 if (recentMigrationsChart) {
   recentMigrationsChart.destroy();
 }
 recentMigrationsChart = new Chart("RecentMigrations", config);
} 

function getFileSizePercentiles(json) {
  var diagnostic;
  let labels = [];
  let values = [];
  for (let j in json.diagnosticSet.diagnostics) {
    diagnostic = json.diagnosticSet.diagnostics[j];
    if (diagnostic.type === "FileTrackerDiagnosticDTO") {
      break;
    }
  }
  fileTrackerPercentile = diagnostic.fileSizePercentiles.fileTrackerPercentile;
  for (let i in fileTrackerPercentile) {
     labels.push(fileTrackerPercentile[i].percentile);
     values.push(fileTrackerPercentile[i].value);
  }
  return {labels, values};
}

function getFileRatePercentiles(json) {
  var diagnostic;
  let labels = [];
  let values = [];
  for (let j in json.diagnosticSet.diagnostics) {
    diagnostic = json.diagnosticSet.diagnostics[j];
    if (diagnostic.type === "FileTrackerDiagnosticDTO") {
      break;
    }
  }
  fileTrackerPercentile = diagnostic.fileTransferRatePercentiles.fileTrackerPercentile;
  for (let i in fileTrackerPercentile) {
     labels.push(fileTrackerPercentile[i].percentile);
     values.push(fileTrackerPercentile[i].value);
  }
  return {labels, values};
}

function processFileRatePercentiles(precentiles) {
  let scaleButton = document.getElementById("FileRatePercentilesButton").value;  
  let scaleType = 'linear'
  if (scaleButton === "linear") {
     scaleType = 'logarithmic';
  }

  const data = {
    labels: precentiles.labels,
    datasets: [
    {
      label: 'File Transfer Rate Percentiles',
      data: precentiles.values,
      backgroundColor: transparentize(255, 165, 0, 0.9),
      borderColor: 'rgb(255,165,0)',
    }]
  };

  const config = {
  type: 'bar',
  data: data,
  options: {
    responsive: true,
    scales: {
      x: {
        display: true,
      },
      y: {
        display: true,
        type: scaleType,
      }
    },
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'File Transfers Rate Percentiles for recently migrated files at ' + diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';

            if (context.parsed.y !== null) {
                label = toMBDecimal(context.parsed.y).toFixed(3) + 'Mbit/s';
            }
            return label;
          },
          title: function(context) {
            return context[0].label + 'th Percentile File Transfer Rate'
          }
        }
      }
     },
   },
 };
 if (fileRateBarChart) {
   fileRateBarChart.destroy();
 }
 fileRateBarChart = new Chart("FileRatePercentiles", config);
}



function processFileSizePercentiles(precentiles) {
  let scaleButton = document.getElementById("FileSizePercentilesButton").value;  
  let scaleType = 'linear'
  if (scaleButton === "linear") {
     scaleType = 'logarithmic';
  }

  const data = {
    labels: precentiles.labels,
    datasets: [
    {
      label: 'FileSize Percentiles',
      data: precentiles.values,
      borderColor: 'rgb(54, 162, 235)',
      backgroundColor: transparentize(54, 162, 235, 0.5),
    }]
  };

  let config = {
  type: 'bar',
  data: data,
  options: {
    responsive: true,
    scales: {
      x: {
        display: true,
      },
      y: {
        display: true,
        type: scaleType,
      }
    },
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'File Size Percentiles for recently migrated files at ' + diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';

            if (context.parsed.y !== null) {
                label = humanFileSize(context.parsed.y);
            }
            return label;
          },
          title: function(context) {
            return context[0].label + 'th Percentile File Size'
          }
        }
      }
     },
   },
 };
 if (fileSizeBarChart) {
   fileSizeBarChart.destroy();
 }
 fileSizeBarChart = new Chart("FileSizePercentiles", config);
}

function processActiveFileLatencyPercentiles(activeFileTrackerPercentiles) {
  const data = {
    labels: activeFileTrackerPercentiles.fileTrackerPercentileRange,
    datasets: [
    {
      label: 'Active File Latency (seconds) Percentiles',
      data: activeFileTrackerPercentiles.fileTrackersLatencyPercentiles,
      backgroundColor: transparentize(255, 165, 0, 0.9),
      borderColor: 'rgb(255,165,0)',
    }]
  };

  const config = {
  type: 'bar',
  data: data,
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Latency for ' + activeFileTrackerPercentiles.count + ' Active Transfers at ' + diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';

            if (context.parsed.y !== null) {
                label = secondsToTime(context.parsed.y);
            }
            return label;
          },
          title: function(context) {
            return context[0].label + 'th Percentile File Latency.'
          }
        }
      }
     },
   },
 };
 if (activeFileLatencyBarChart) {
   activeFileLatencyBarChart.destroy();
 }
 activeFileLatencyBarChart = new Chart("ActiveLatencyPercentiles", config);
}

document.getElementById("ActiveMigrations").onclick = function(evt) {
  var activePoint = activeMigrationsChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
  if (activePoint.length > 0) {
     var clickedElementindex = activePoint[0].index;
     let migration_name = activeMigrationsChart.data.labels[clickedElementindex];
     uri = getMigrationLink(migration_name);
     window.location.href = uri;
  }          
}            
             
document.getElementById("RecentMigrations").onclick = function(evt) {
  var activePoint = recentMigrationsChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);  
  if (activePoint.length > 0) {
     var clickedElementindex = activePoint[0].index;
     let migration_name = recentMigrationsChart.data.labels[clickedElementindex];
     uri = getMigrationLink(migration_name);
     window.location.href = uri;
  }      
}     


function processActiveFileRatePercentiles(activeFileTrackerPercentiles) {
  let scaleButton = document.getElementById("ActiveRatePercentilesButton").value;  
  let scaleType = 'linear'
  if (scaleButton === "linear") {
     scaleType = 'logarithmic';
  }

  const data = {
    labels: activeFileTrackerPercentiles.fileTrackerPercentileRange,
    datasets: [
    {
      label: 'Active File Transfer Rate Percentiles',
      data: activeFileTrackerPercentiles.fileTrackersRatePercentiles,
      backgroundColor: transparentize(255, 165, 0, 0.9),
      borderColor: 'rgb(255,165,0)',
    }]
  };

  const config = {
  type: 'bar',
  data: data,
  options: {
    responsive: true,
    scales: {
      x: {
        display: true,
      },
      y: {
        display: true,
        type: scaleType,
      }
    },
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'File Transfer Rate for ' + activeFileTrackerPercentiles.count + ' Active Transfers at ' +  diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';

            if (context.parsed.y !== null) {
                label = toMBDecimal(context.parsed.y).toFixed(3) + 'Mbit/s';
            }
            return label;
          },
          title: function(context) {
            return context[0].label + 'th Percentile File Transfer Rate'
          }
        }
      }
     },
   },
 };
 if (activeFileRateBarChart) {
   activeFileRateBarChart.destroy();
 }
 activeFileRateBarChart = new Chart("ActiveRatePercentiles", config);
}


function processActiveFileSizePercentiles(activeFileTrackerPercentiles, timeStamp) {
  let scaleButton = document.getElementById("ActiveFileSizePercentilesButton").value;  
  let scaleType = 'linear'
  if (scaleButton === "linear") {
     scaleType = 'logarithmic';
  }

  const data = {
    labels: activeFileTrackerPercentiles.fileTrackerPercentileRange,
    datasets: [
    {
      label: 'Active File Transfer Size Percentiles',
      data: activeFileTrackerPercentiles.fileTrackersSizePercentiles,
      borderColor: 'rgb(54, 162, 235)',
      backgroundColor: transparentize(54, 162, 235, 0.5),
    }]
  };

  const config = {
  type: 'bar',
  data: data,
  options: {
    responsive: true,
    scales: {
      x: {
        display: true,
      },
      y: {
        display: true,
        type: scaleType,
      }
    },
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'File Size for '+ activeFileTrackerPercentiles.count + ' Active Transfers at ' + diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
     tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';

            if (context.parsed.y !== null) {
                label = humanFileSize(context.parsed.y);
            }
            return label;
          },
          title: function(context) {
            return context[0].label + 'th Percentile File Size'
          }
        }
     }
     },
   },
 };
 if (activeFileSizeBarChart) {
   activeFileSizeBarChart.destroy();
 }
 activeFileSizeBarChart = new Chart("ActiveFileSizePercentiles", config);
}


function processActiveMigrations(activeFileTrackerPercentiles) {
  // Convert ids to names
  migrationNames = [] 
  for (let i in activeFileTrackerPercentiles.fileTrackerMigrationMapKeys) {
     migrationNames.push(migrationIdMap[activeFileTrackerPercentiles.fileTrackerMigrationMapKeys[i]]);
  }
  const data = {
    labels: migrationNames,
    datasets: [
    {
      label: 'Active File Transfers for Migration',
      data: activeFileTrackerPercentiles.fileTrackerMigrationMapValues,
      borderColor: 'rgb(54, 162, 235)',
      backgroundColor: transparentize(54, 162, 235, 0.5),
    }]
  };

  const config = {
  type: 'bar',
  data: data,
  options: {
    indexAxis: 'y',
    responsive: true,
    onHover: (event, chartElement) => {
         event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
    },
    scales : {
      y : {
         display: false,
      }
    },
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Migrations with ' + activeFileTrackerPercentiles.count + ' total Active Transfers at ' + diagnosticsTimeSeries.middle,
          font: {
               size: 16
          },
      },
      tooltip: {
        callbacks: {
           title: function(context) {
              return context[0].label
            }
        },
      },
     },
   },
 };
 if (activeMigrationsChart) {
   activeMigrationsChart.destroy();
 }
 activeMigrationsChart = new Chart("ActiveMigrations", config);
}


function updateTableDate(newDate) {
     document.getElementById("table-title-header").innerHTML = 
        newDate;
}

function onSliderUpdate() {
}

document.getElementById("ThroughPutChart").onclick = function(evt) {
  var activePoint = throughPutChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);

  // make sure click was on an actual point
  if (activePoint.length > 0) {
    var clickedElementindex = activePoint[0].index;
    diagnosticsTimeSeries.middle = 
           diagnosticsTimeSeries.dates[
                 diagnosticsTimeSeries.dates.indexOf(diagnosticsTimeSeries.start)
                      + clickedElementindex];
    throughPutChart.options.plugins.annotation.annotations.line1.xMin = 
           diagnosticsTimeSeries.middle;
    throughPutChart.options.plugins.annotation.annotations.line1.xMax = 
           diagnosticsTimeSeries.middle;
    throughPutChart.update();
    slider.noUiSlider.setHandle(1, diagnosticsTimeSeries.middle, false, false);
    getDiagnostic(diagnosticsTimeSeries.timeStamps[diagnosticsTimeSeries.datesIndexMap[diagnosticsTimeSeries.middle]]);
    reWriteLinks();
  }
};

function onSliderChange() {
    updateThroughPutChart();
    getDiagnostic(diagnosticsTimeSeries.timeStamps[diagnosticsTimeSeries.datesIndexMap[diagnosticsTimeSeries.middle]]);
    reWriteLinks();
}

function getConnectionTotals(connectionTotals) {
  let totalRxQueue = 0;
  let totalTxQueue = 0;
  let retrnsmt = 0;
  for (var connectionTotal in connectionTotals) {
    totalRxQueue = totalRxQueue + connectionTotals[connectionTotal].totalRxQueue;
    totalTxQueue = totalTxQueue + connectionTotals[connectionTotal].totalTxQueue;
    retrnsmt = retrnsmt + connectionTotals[connectionTotal].retrnsmt;
  }
  return {totalRxQueue, totalTxQueue, retrnsmt}
}

function getConnectionDetails(diagnostic) {
  let totals = getConnectionTotals(diagnostic.connectionTotals);
  document.getElementById("diagnostic-summary-table-connections").innerHTML = diagnostic.connections.length;

  document.getElementById("diagnostic-summary-table-rx").innerHTML = 
	humanFileSize(totals.totalRxQueue, true) + ' (' + totals.totalRxQueue.toLocaleString("en-US") + ')';

  document.getElementById("diagnostic-summary-table-tx").innerHTML = 
	humanFileSize(totals.totalTxQueue, true) + ' (' + totals.totalTxQueue.toLocaleString("en-US") + ')';

  if (totals.retrnsmt > 1) {
    document.getElementById("diagnostic-summary-table-retransmit").innerHTML = 
        "<div style=\"font-weight: bold;color:red\">" + totals.retrnsmt + "</div>";
  } else if (totals.retrnsmt === 1) {
    document.getElementById("diagnostic-summary-table-retransmit").innerHTML =
        "<div style=\"font-weight: bold;color:orange\">" + totals.retrnsmt + "</div>";
  } else {
    document.getElementById("diagnostic-summary-table-retransmit").innerHTML = totals.retrnsmt;
  }
}

function getThroughPut(diagnostic) {
  let bytesPerSecond = Math.round(diagnostic.bytesMigrated/diagnostic.period);	
  document.getElementById("diagnostic-summary-table-bytes-per-second").innerHTML = 
             humanFileSize(bytesPerSecond,true) + ' / ' + humanFileSize(diagnostic.peakBytesMigrated, true);
  document.getElementById("diagnostic-summary-table-rate-per-second").innerHTML = 
             toMBSecond(bytesPerSecond) + " Mbit/s" + ' / ' + toMBSecond(diagnostic.peakBytesMigrated) + " Mbit/s";
  document.getElementById("diagnostic-summary-table-file-for-period").innerHTML  = diagnostic.filesMigrated;
  document.getElementById("diagnostic-summary-table-file-period").innerHTML  = diagnostic.period;
  document.getElementById("diagnostic-summary-table-file-per-second").innerHTML  = 
            Math.round(diagnostic.filesMigrated/diagnostic.period) + ' / ' + diagnostic.peakFilesMigrated;
}

function getCPULoad(diagnostic) {
  if (diagnostic.systemCpuLoad > 0.9) {
    document.getElementById("diagnostic-summary-system-cpu").innerHTML =
         "<div style=\"font-weight: bold;color:red\">" + diagnostic.systemCpuLoad.toFixed(3) + "</div>";
  } else if (diagnostic.systemCpuLoad > 0.7) {
    document.getElementById("diagnostic-summary-system-cpu").innerHTML =
         "<div style=\"font-weight: bold;color:orange\">" + diagnostic.systemCpuLoad.toFixed(3) + "</div>";
  } else {
    document.getElementById("diagnostic-summary-system-cpu").innerHTML = diagnostic.systemCpuLoad.toFixed(3);
  }

  if (diagnostic.processCpuLoad > 0.9) {
    document.getElementById("diagnostic-summary-process-cpu").innerHTML =
         "<div style=\"font-weight: bold;color:red\">" + diagnostic.processCpuLoad.toFixed(3)  + "</div>";
  } else if (diagnostic.processCpuLoad > 0.7) {
    document.getElementById("diagnostic-summary-process-cpu").innerHTML = 
         "<div style=\"font-weight: bold;color:orange\">" + diagnostic.processCpuLoad.toFixed(3) + "</div>";
  } else {
    document.getElementById("diagnostic-summary-process-cpu").innerHTML = diagnostic.processCpuLoad.toFixed(3);
  }
}

function getIOLoad(diagnostic) {
  let value = '-';
  if (diagnostic.hasOwnProperty('iowaitPercentage')) {
     value = diagnostic.iowaitPercentage;
  }
  if (value === '-') { 
      document.getElementById("diagnostic-summary-io-wait").innerHTML = value;
  }

  if (value > 3.0) {
     document.getElementById("diagnostic-summary-io-wait").innerHTML =
       "<div style=\"font-weight: bold;color:red\">" + value + "</div>";
  } else if (value > 1.0) {
     document.getElementById("diagnostic-summary-io-wait").innerHTML = 
       "<div style=\"font-weight: bold;color:orange\">" + value + "</div>"; 
  } else {
     document.getElementById("diagnostic-summary-io-wait").innerHTML = value;
  }
}

function getMigrationDiagnostic(diagnostic) {
  if (diagnostic.totalPendingRegions > 1000000) {
     document.getElementById("diagnostic-summary-pending-region").innerHTML = 
       "<div style=\"font-weight: bold;color:red\">" + 
           diagnostic.totalPendingRegions.toLocaleString("en-US") + "</div>";
  } else if (diagnostic.totalPendingRegions > 500000) {
     document.getElementById("diagnostic-summary-pending-region").innerHTML = 
        "<div style=\"font-weight: bold;color:orange\">" +
                diagnostic.totalPendingRegions.toLocaleString("en-US") + "</div>";;
  } else {
     document.getElementById("diagnostic-summary-pending-region").innerHTML = 
                diagnostic.totalPendingRegions.toLocaleString("en-US");
  }

  document.getElementById("diagnostic-summary-failed-paths").innerHTML = 
                diagnostic.totalFailedPaths.toLocaleString("en-US");
  document.getElementById("diagnostic-summary-total-retries").innerHTML = 
                diagnostic.totalPathRetryCount.toLocaleString("en-US");
  if ("migrationPathsRequeued" in diagnostic) {
     let totalRequeues = 0;
     for (const key in diagnostic.migrationPathsRequeued) {
         totalRequeues = totalRequeues + diagnostic.migrationPathsRequeued[key];
     }
     document.getElementById("diagnostic-summary-total-requeues").innerHTML = 
            totalRequeues.toLocaleString("en-US");
  }
}


function getEventManagerDiagnostic(diagnostic) {
  document.getElementById("diagnostic-summary-event-queue").innerHTML = 
         diagnostic.totalQueuedEvents.toLocaleString("en-US");
  document.getElementById("diagnostic-summary-event-manager-added").innerHTML = 
         diagnostic.totalEventAdded.toLocaleString("en-US");
  document.getElementById("diagnostic-summary-event-manager-avg-db").innerHTML = 
         diagnostic.meanDbTime;

  if (diagnostic.maxDbTime > 500) {
    document.getElementById("diagnostic-summary-event-manager-max-db").innerHTML = 
         "<div style=\"font-weight: bold;color:red\">" + diagnostic.maxDbTime + "</div>";
  } else if (diagnostic.maxDbTime > 200) {
    document.getElementById("diagnostic-summary-event-manager-max-db").innerHTML = 
         "<div style=\"font-weight: bold;color:orange\">" + diagnostic.maxDbTime + "</div>";
  } else {
    document.getElementById("diagnostic-summary-event-manager-max-db").innerHTML = 
         diagnostic.maxDbTime;
  }
}

function getFileTracker(diagnostic) {
  document.getElementById("diagnostic-summary-active-transfers").innerHTML = 
         diagnostic.fileTrackers.length;
  let totalFileTransferSize = 0;
  let totalBytesTransferred = 0;
  for (var i = 0; i <  diagnostic.fileTrackers.length; i++) {
    totalFileTransferSize = totalFileTransferSize + diagnostic.fileTrackers[i].FileLength;
    totalBytesTransferred = totalBytesTransferred + diagnostic.fileTrackers[i].BytesTransferred;
  }
 
  if (totalFileTransferSize > 200000000000) { //200GB 
     document.getElementById("diagnostic-summary-total-size-transfers").innerHTML = 
         "<div style=\"font-weight: bold;color:red\">" + 
         humanFileSize(totalBytesTransferred, true) + " / " +
         humanFileSize(totalFileTransferSize, true) + "</div>";
  } else if (totalFileTransferSize > 100000000000) { //100GB 
     document.getElementById("diagnostic-summary-total-size-transfers").innerHTML = 
         "<div style=\"font-weight: bold;color:orange\">" + 
         humanFileSize(totalBytesTransferred, true) + " / " +
         humanFileSize(totalFileTransferSize, true) + "</div>";
  } else {
     document.getElementById("diagnostic-summary-total-size-transfers").innerHTML = 
         humanFileSize(totalBytesTransferred, true) + " / " +
         humanFileSize(totalFileTransferSize, true);
  }
}

function getJvmGcDiagnostic(diagnostic, timeStamp) {
  document.getElementById("diagnostic-summary-gc-avg-time").innerHTML = 
          (Math.floor(diagnostic.gcPauseTime/diagnostic.gcCount)).toLocaleString("en-US");

  const gcForPeriod = getGCForTime(timeStamp);
  if (gcForPeriod === "-") {
     document.getElementById("diagnostic-summary-gc-time-period").innerHTML = 
        gcForPeriod;
  }
  
  if (gcForPeriod > 2000) {
    document.getElementById("diagnostic-summary-gc-time-period").innerHTML = 
        "<div style=\"font-weight: bold;color:red\">" + gcForPeriod.toLocaleString("en-US") + "</div>";
  } else if (gcForPeriod > 1000) {
    document.getElementById("diagnostic-summary-gc-time-period").innerHTML = 
        "<div style=\"font-weight: bold;color:orange\">" + gcForPeriod.toLocaleString("en-US") + "</div>";
  } else {
    document.getElementById("diagnostic-summary-gc-time-period").innerHTML = 
        gcForPeriod.toLocaleString("en-US");
  }
}

function processDiagnostic(json) {
 let actionTotal = 0;
 for (let j in json.diagnosticSet.diagnostics) {
   let diagnostic = json.diagnosticSet.diagnostics[j]
   switch (diagnostic.type) {
      case "NetworkStatusDTO":
         getConnectionDetails(diagnostic);
         break;
      case "ThroughputDiagnosticDTO":
         getThroughPut(diagnostic);
         break;
      case "CpuLoadDiagnosticDTO":
         getCPULoad(diagnostic);
         break;
      case "LinuxPressureDiagnosticDTO":
         getIOLoad(diagnostic);
         break;
      case "MigrationDiagnosticDTO":
         getMigrationDiagnostic(diagnostic);
         break;
      case "ActionStoreDiagnosticDTO":
         // Processed in line here.
         actionTotal += diagnostic.totalUnExecutedEvents;
         break;
      case "EventManagerDiagnosticDTO":
         getEventManagerDiagnostic(diagnostic);
         break;
      case "FileTrackerDiagnosticDTO":
         getFileTracker(diagnostic);
         break;
      case "JvmGcDiagnosticDTO":
         getJvmGcDiagnostic(diagnostic, json.diagnosticSet.timeStamp);
         break;
      default:
         break;
   }
 }
 
 if (actionTotal > 1000000) {
     document.getElementById("diagnostic-summary-action-queue").innerHTML = 
       "<div style=\"font-weight: bold;color:red\">" +
        actionTotal.toLocaleString("en-US") + "</div>";
 } else if (actionTotal > 500000) {
     document.getElementById("diagnostic-summary-action-queue").innerHTML = 
      "<div style=\"font-weight: bold;color:orange\">" +
        actionTotal.toLocaleString("en-US") + "</div>";
 } else {
     document.getElementById("diagnostic-summary-action-queue").innerHTML = 
        actionTotal.toLocaleString("en-US");
 }
}

function clickJump(x) {
   if (x.id === 'network-throughput-row' || x.id === "file-throughput-row") {
       window.location.href = getThroughputLink();
   }
   if (x.id === 'file-tracker-row') {
       window.location.href = getFileTrackerLink();
   }
   if (x.id === 'migration-row' || x.id === 'migration-failure-row') {
       window.location.href = getMigrationsLink();
   }
   if (x.id === 'filesystem-event-row' || x.id === 'system-row') {
       window.location.href = getSystemLink();
   }
   if (x.id === 'network-status-row') {
       window.location.href = getNetworkLink();
   }
}


var previousIndex = -1;
async function getDiagnostic(index) {
  try {
    if (previousIndex === index) {
       return;
    }
    previousIndex = index;
    let json = await loadDiagnostic(index);

    // Set up all date arrays and maps
    updateTableDate(toDate(json.diagnosticSet.timeStamp));

    activeFileTrackerPercentiles = getCurrentTransferPercentiles(json.diagnosticSet);
    buildMigrationIdMap(json.diagnosticSet.diagnostics);
    processDiagnostic(json);
    processActiveFileRatePercentiles(activeFileTrackerPercentiles);
    processActiveFileSizePercentiles(activeFileTrackerPercentiles);
    processActiveFileLatencyPercentiles(activeFileTrackerPercentiles);
    processActiveMigrations(activeFileTrackerPercentiles);

    fileTrackerPercentiles = getFileSizePercentiles(json);
    processFileSizePercentiles(fileTrackerPercentiles);

    fileTrackerRatePercentiles = getFileRatePercentiles(json); 
    processFileRatePercentiles(fileTrackerRatePercentiles);

    recentMigrations = getRecentMigrations(json.diagnosticSet);
    processRecentActivityMigrations(recentMigrations); 
    reWriteLinks();
    return;
  } catch (error) {
    console.log(error);
  }
}



function getGCForTime(timeStamp) {
   if (timeStamp in jvmGCTimeMap) {
      return jvmGCTimeMap[timeStamp];
   }
   return "-";
}

async function getJvmGCTime() {
  try {
    let json = await loadReport('jvmGC.gz');
    let gcTimeForPeriod = json.gcTimeForPeriod;
    let gcTimes = json.timeStamp;    
    for (var i = 0; i < gcTimes.length; i++) { 
       jvmGCTimeMap[gcTimes[i]] = gcTimeForPeriod[i];
    }
  } catch (error) {
    console.log(error);
  }
}


async function getThroughputChart() {
  try {
    let json = await loadReport('throughput.gz');
    generateDiagnosticTimeSeries(json.timeStamp);
    // Get the diagnostics asynchronously
    getDiagnostic(diagnosticsTimeSeries.timeStamps[diagnosticsTimeSeries.datesIndexMap[diagnosticsTimeSeries.middle]]);
    // Generate the slider
    renderSlider(slider, onSliderUpdate, onSliderChange);    
    // Draw chart
    let start = diagnosticsTimeSeries.datesIndexMap[diagnosticsTimeSeries.start];
    let middle = diagnosticsTimeSeries.datesIndexMap[diagnosticsTimeSeries.middle];
    let end = diagnosticsTimeSeries.datesIndexMap[diagnosticsTimeSeries.end]
    doThroughPutChart(json, start, middle, end);
    return;
  } catch (error) {
    console.log(error);
  }
}

getJvmGCTime();
getThroughputChart();
reWriteLinks();

</script>
</body>
</html>
